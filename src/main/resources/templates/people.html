<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>People List</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />

    <style>
        table { width:100%; border-collapse: collapse; }
        th,td { border:1px solid #ddd; padding:8px; }
        th { background:#f4f4f4; }
        .controls { margin-bottom:1rem; display:flex; gap:8px; flex-wrap:wrap; }
    </style>
</head>
<body>
<nav>
    <a href="/content-groups">Content Groups</a>
    <a href="/locations">Locations</a>
</nav>

<h1>People List</h1>

<div class="controls">
    <input id="filterName" placeholder="Name" />
    <input id="filterEyeColor" placeholder="Eye Color" />
    <input id="filterHairColor" placeholder="Hair Color" />
    <input id="filterNationality" placeholder="Nationality" />

    <select id="byName"><option value="">Name</option><option value="ASC">Name ↑</option><option value="DESC">Name ↓</option></select>
    <select id="byEyeColor"><option value="">Eye</option><option value="ASC">Eye ↑</option><option value="DESC">Eye ↓</option></select>
    <select id="byHairColor"><option value="">Hair</option><option value="ASC">Hair ↑</option><option value="DESC">Hair ↓</option></select>
    <select id="byNationality"><option value="">Nation</option><option value="ASC">Nation ↑</option><option value="DESC">Nation ↓</option></select>

    <button id="apply">Apply</button>
    <button id="clear">Clear</button>

    <button id="openAdd">Add New Person</button>
</div>

<table>
    <thead>
    <tr>
        <th>Name</th>
        <th>Eye Color</th>
        <th>Hair Color</th>
        <th>Nationality</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="peopleBody">
    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
    </tbody>
</table>

<div id="pagination" style="margin-top:12px;"></div>

<!-- Add modal (simple) -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4);">
    <div style="background:#fff; margin:6% auto; padding:16px; width:320px; position:relative;">
        <button id="closeAdd" style="position:absolute; right:8px; top:8px;">×</button>
        <h3>Add Person</h3>
        <div><input id="addName" placeholder="Name" required /></div>
        <div>
            <select id="addEyeColor">
                <option>GREEN</option><option>RED</option><option>BLUE</option><option>YELLOW</option>
            </select>
        </div>
        <div>
            <select id="addHairColor">
                <option>GREEN</option><option>RED</option><option>BLUE</option><option>YELLOW</option>
            </select>
        </div>
        <div>
            <select id="addNationality">
                <option>RUSSIA</option><option>UNITED_KINGDOM</option><option>CHINA</option><option>INDIA</option>
            </select>
        </div>
        <div style="margin-top:8px;"><button id="saveAdd">Save</button></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stomp-websocket/lib/stomp.min.js"></script>

<script>
    const apiBase = '/api/person';
    let currentPage = 0;
    let pageSize = 10;
    let totalPages = 0;

    function getTokenHeader() {
        const token = localStorage.getItem('token');
        return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function buildQuery(params) {
        const esc = encodeURIComponent;
        return Object.entries(params)
            .filter(([,v]) => v !== undefined && v !== '' && v !== null)
            .map(([k,v]) => esc(k) + '=' + esc(v))
            .join('&');
    }

    async function loadPeople(page = 0) {
        const params = {
            name: document.getElementById('filterName').value,
            eyeColor: document.getElementById('filterEyeColor').value,
            hairColor: document.getElementById('filterHairColor').value,
            nationality: document.getElementById('filterNationality').value,
            byName: document.getElementById('byName').value || undefined,
            byEyeColor: document.getElementById('byEyeColor').value || undefined,
            byHairColor: document.getElementById('byHairColor').value || undefined,
            byNationality: document.getElementById('byNationality').value || undefined,
            page: page,
            size: pageSize
        };
        const q = buildQuery(params);
        const res = await fetch(apiBase + (q ? '?' + q : ''), { headers: { 'Content-Type':'application/json', ...getTokenHeader() } });
        if (res.status === 401 || res.status === 403) {
            // not authorized — redirect to login
            window.location.href = '/login';
            return;
        }
        if (!res.ok) {
            document.getElementById('peopleBody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">Error loading data</td></tr>';
            return;
        }
        const pageData = await res.json();
        renderTable(pageData);
    }

    function renderTable(pageData) {
        const body = document.getElementById('peopleBody');
        body.innerHTML = '';
        if (!pageData || !pageData.content || pageData.content.length === 0) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center;"><strong>Результатов не найдено.</strong></td></tr>';
        } else {
            pageData.content.forEach(person => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${escapeHtml(person.name || '')}</td>
          <td>${escapeHtml(person.eyeColor || '')}</td>
          <td>${escapeHtml(person.hairColor || '')}</td>
          <td>${escapeHtml(person.nationality || '')}</td>
          <td>
            <button data-id="${person.id}" class="deleteBtn">Delete</button>
          </td>
        `;
                body.appendChild(tr);
            });
        }
        currentPage = pageData.number || 0;
        totalPages = pageData.totalPages || 0;
        renderPagination();
        attachDeleteHandlers();
    }

    function renderPagination() {
        const p = document.getElementById('pagination');
        p.innerHTML = '';
        if (totalPages <= 1) return;
        if (currentPage > 0) {
            const prev = document.createElement('button');
            prev.textContent = 'Previous';
            prev.onclick = () => loadPeople(currentPage - 1);
            p.appendChild(prev);
        }
        const info = document.createElement('span');
        info.textContent = ` Page ${currentPage + 1} of ${totalPages} `;
        p.appendChild(info);
        if (currentPage < totalPages - 1) {
            const next = document.createElement('button');
            next.textContent = 'Next';
            next.onclick = () => loadPeople(currentPage + 1);
            p.appendChild(next);
        }
    }

    function attachDeleteHandlers() {
        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.getAttribute('data-id');
                if (!confirm('Delete person?')) return;
                const res = await fetch(apiBase + '?id=' + encodeURIComponent(id), {
                    method: 'DELETE',
                    headers: { 'Content-Type':'application/json', ...getTokenHeader() }
                });
                if (res.status === 401 || res.status === 403) { window.location.href = '/login'; return; }
                if (res.ok) { loadPeople(currentPage); }
                else alert('Delete failed');
            };
        });
    }

    document.getElementById('apply').onclick = () => loadPeople(0);
    document.getElementById('clear').onclick = () => {
        ['filterName','filterEyeColor','filterHairColor','filterNationality'].forEach(id => document.getElementById(id).value = '');
        ['byName','byEyeColor','byHairColor','byNationality'].forEach(id => document.getElementById(id).value = '');
        loadPeople(0);
    };

    // Add person
    document.getElementById('openAdd').onclick = () => document.getElementById('modal').style.display = 'block';
    document.getElementById('closeAdd').onclick = () => document.getElementById('modal').style.display = 'none';
    document.getElementById('saveAdd').onclick = async () => {
        const payload = {
            name: document.getElementById('addName').value,
            eyeColor: document.getElementById('addEyeColor').value,
            hairColor: document.getElementById('addHairColor').value,
            nationality: document.getElementById('addNationality').value
        };
        const res = await fetch(apiBase, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', ...getTokenHeader() },
            body: JSON.stringify(payload)
        });
        if (res.status === 401 || res.status === 403) { window.location.href = '/login'; return; }
        if (res.ok) { document.getElementById('modal').style.display = 'none'; loadPeople(currentPage); }
        else alert('Save failed');
    };

    // WebSocket to refresh list
    let stompClient = null;
    function connectWs() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            stompClient.subscribe('/topic/people', function() { loadPeople(currentPage); });
        }, function(err){ console.log('WS error', err); });
    }

    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

    // attach global fetch wrapper to include token for non-GET forms if needed
    (function(){
        const orig = window.fetch;
        window.fetch = function(url, opts = {}) {
            opts.headers = { ...(opts.headers || {}), ...getTokenHeader() };
            return orig(url, opts);
        };
    })();

    // initial load
    connectWs();
    loadPeople(0);
</script>
</body>
</html>
